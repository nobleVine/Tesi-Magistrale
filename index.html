<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>
        Graph Visualization
    </title>

    <link rel="icon" type="image/ico" href="iconGraph.png" />

    <link rel="stylesheet" href="jquery-ui.css">

    <style type="text/css">
        body {
            margin: 10;
            background-color: #D3D3D3;
        }

        #accordion {
            width: 25%;
        }

        #accordion2 {
            width: 25%;
        }

        #graphSection {
            width: 50%;
            height: 80%;
        }

        input {
            width: 10%;
            word-spacing: 5px;
        }

        #buttonDraw {
            width: 90px;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        #buttonDraw2 {
            width: 90px;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        #buttonCompute {
            width: 100px;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        #startingSequence {
            width: 70px;
        }

        #sequence {
            width: 70px;
        }

        #numberOfNodes {
            width: 70px;
        }

        #section1 {
            background-color: #ebebe0;
            text-align: justify;
            font-family: "Comic Sans MS";
        }

        #section2 {
            background-color: #ebebe0;
            font-family: "Comic Sans MS";
        }

        #section3 {
            background-color: #ebebe0;
            font-family: "Comic Sans MS";
        }

        #result {
            width: 70px;
        }

        #sequenceName {
            font-family: "Comic Sans MS";
        }

        #sequenceNumber {
            font-family: "Comic Sans MS";
        }

        #nodesClick {
            font-family: "Comic Sans MS";
            color: #3d3d29;
            text-shadow: 7px 7px 7px rgb(122, 122, 82);
            font-size: 20;
        }

        #download2 {
            width: auto;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        #download {
            width: 70px;
        }
    </style>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>
        $(function () {
            $("#accordion").accordion({
                collapsible: true,
                heightStyle: "content",
                active: false
            });
        });
    </script>

</head>

<body>
    <center>
        <font size="10" color="Black" style="text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;">
            Interactive Graph
        </font>
        <br>
        <br>
    </center>
    <div id="accordion" style="float: left;">
        <h3>
            <b>
                Starting sequence references
            </b>
        </h3>
        <div id="section1">
            <form action="javascript:drawSpecializedGraph()">
                <table>
                    Insert the id of the sequence of which you want to see all her references and the maximum number of
                    related sequences that you want to show, to draw the graph with these sequences related to the
                    starting sequence.
                    <br>
                    <br>
                    <tr>
                        <td>
                            <b>starting sequence</b>
                        </td>
                        <td>
                            <input type="text" id="startingSequence"
                                title="Insert the id of the sequence of which you want to see all the references">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <b>number of nodes</b>
                        </td>
                        <td>
                            <input type="text" id="numberOfNodes"
                                title="Insert the maximum number of related sequences that you want to show">
                        </td>
                    </tr>
                </table>
                <br>
                <input type="submit" value="Draw It!" id="buttonDraw"
                    title="Click here to draw the graph with all the related sequences from starting sequence">
            </form>
            <form action="https://localhost/tesi-magistrale/fetchAndRebuild.php" method="POST">
                <table>
                    <tr>
                        <td>
                            <input type="text" name='sequence' id="download">
                        </td>
                        <td>
                            <input type="submit" value="Download It!" method="POST" id="download2">
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        <h3>
            <b>
                Fetched sequences
            </b>
        </h3>
        <div id="section2">
            <form action="javascript:drawFetchedSequencesGraph()" id="form2">
                Draw the graph with the fetched sequences.
                <br>
                <br>
                <input type="submit" value="Draw It!" id="buttonDraw2"
                    title="Click here to draw the graph with all the fetched related sequences">
            </form>
        </div>
        <h3>
            <b>
                Number of related sequences
            </b>
        </h3>
        <div id="section3">
            <form action="javascript:numberOfRelatedSequences()">
                Calculates how many related sequences there are compared to the one given among those fetched and shows
                only the nodes and the edges directly connected to the input sequence.
                <br>
                <br>
                <input type="text" id="sequence" title="Insert the sequence id">
                <input type="submit" value="Compute" id="buttonCompute" title="Click here to compute">
                <input type="text" id="result">
            </form>
        </div>
    </div>
    <div id="accordion2" style="float: right;">
        <h3>
            <b id="Title1">
            </b>
        </h3>
        <div id="sequenceName"></div>

        <h3>
            <b id="Title2">

            </b>
        </h3>
        <div id="sequenceNumber"></div>
    </div>

    <div id="graphSection" style="float: left;">
    </div>

    <p hidden id="nodesClick">Click on a node to show the associated informations</p>

    <script src="libraries\build\sigma.min.js"></script>

    <script src="./GlobalJSON.json"></script>

    <script>

        var array_numbers = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
        document.getElementById("download").addEventListener("click", clearInput);

        var s = new sigma('graphSection');

        s.settings({
            hoverFont: "Comic Sans MS",
            labelHoverBGColor: "default",
            defaultHoverLabelBGColor: "#ffffff",
            defaultNodeColor: "#007fff",
            nodeColor: "default",
            defaultEdgeColor: "#000000",
            edgeColor: "default",
            defaultLabelColor: "#F70611",
            labelColor: "default",
            labelHoverShadow: "default",
            labelHoverShadowColor: "#000099",
            labelThreshold: 100,
            enableCamera: false
        });

        function take_sequences(sequenzaJSON) {
            xref_list = sequenzaJSON.results[0].xref;
            if (typeof xref_list !== 'undefined') {
                let array_sequences = [];
                for (i = 0; i < xref_list.length; i++) { // Loop that scans xref elements.
                    element = xref_list[i];
                    for (j = 0; j < element.length; j++) { // Loop that scans the letters of xref elements.
                        if (element[j] === "A") { // Each sequences has the form Axxxxxx.
                            for (v = 0; v < array_numbers.length; v++) {
                                if (element[j + 1] === array_numbers[v]) {
                                    array_sequences.push("A" + element.substring(j + 1, j + 7));
                                    j = j + 7; // Useful for optimizing the code. If you find a "A", you can jump the next xxxxxx.
                                    break;
                                }
                            }
                        }
                    }
                }
                let set_sequences = [...new Set(array_sequences)];
                return set_sequences;
            } else {
                return 'undefined';
            }
        }

        function drawSpecializedGraph() {

            s.graph.clear();
            var present = false;

            document.getElementById("startingSequence").addEventListener("click", clearInput);
            document.getElementById("buttonDraw").addEventListener("click", hideAccordion);
            document.getElementById("buttonDraw2").addEventListener("click", hideAccordion);
            document.getElementById("buttonCompute").addEventListener("click", hideAccordion);

            let edge_number = 0;

            sequence = document.getElementById("startingSequence").value;
            nodesToAdd = document.getElementById("numberOfNodes").value;

            if (sequence === "" && nodesToAdd === "") {
                alert("Both the starting sequence and the number of nodes not inserted");
                return;
            } else if (sequence === "") {
                alert("There is no sequence inserted");
                return;
            } else if (nodesToAdd === "") {
                alert("Number of nodes not inserted");
                return;
            }

            json_list.forEach(element => {
                if (element.query.substring(3, 11) === sequence) {
                    s.graph.addNode({
                        id: '' + sequence,
                        label: '' + sequence,
                        x: 1,
                        y: 1,
                        size: 5
                    });
                    initial_sequence = element;
                    present = true;
                    return;
                }
            });

            if (typeof initial_sequence === 'undefined' || present === false) {
                alert("The sequence " + sequence + " has not been fetched!");
                return;
            }

            let nodes_list = take_sequences(initial_sequence);

            if (nodesToAdd > nodes_list.length) {
                alert("The maximum number of nodes that can be requested is " + nodes_list.length);
            } else {
                for (i = 0; i < nodesToAdd; i++) {
                    var theta = i * 2 * Math.PI / nodesToAdd;
                    s.graph.addNode({
                        id: '' + nodes_list[i],
                        label: '' + nodes_list[i],
                        x: 10 * Math.sin(theta),
                        y: 10 * Math.cos(theta),
                        size: 3
                    }).addEdge({
                        id: 'e' + edge_number,
                        source: '' + sequence,
                        target: '' + nodes_list[i],
                        size: 3
                    });
                    edge_number++;
                }
                s.refresh();
                showHelp();
                showInformation();
            }
        }

        function showInformation() { // This function shows informations about the selected sequence.

            s.bind("clickNode", function (e) {

                $("#accordion2").accordion({ // This is the accordion where informations'll shown.
                    collapsible: true,
                    heightStyle: "content",
                    active: 0
                });

                document.getElementById("accordion2").style.display = "block";
                document.getElementById("Title1").innerHTML = "Sequence Name and Recurrence Function";
                document.getElementById("Title2").innerHTML = "Sequence Number";

                for (h = 0; h < json_list.length; h++) {
                    entrato = false;
                    if (e.data.node.label === json_list[h].query.substring(3, 11)) {
                        document.getElementById("sequenceName").innerHTML = json_list[h].query.substring(3, 11) + "<br>" + json_list[h].results[0].name;
                        document.getElementById("sequenceNumber").innerHTML = json_list[h].results[0].data;
                        entrato = true;
                        break;
                    }
                }

                if (entrato === false) {
                    alert("The clicked sequence " + e.data.node.label + " has not been fetched");
                }

            });
        }

        function showHelp() {
            document.getElementById("nodesClick").style.display = "block";
            s.bind("clickNode", function () {
                document.getElementById("nodesClick").style.display = "none";
            });
        }

        function drawFetchedSequencesGraph() {

            s.graph.clear();

            document.getElementById("buttonDraw").addEventListener("click", hideAccordion);
            document.getElementById("buttonDraw2").addEventListener("click", hideAccordion);
            document.getElementById("buttonCompute").addEventListener("click", hideAccordion);

            var list_refs = [];

            for (z = 0; z < json_list.length; z++) {
                seq = take_sequences(json_list[z]);
                if (typeof seq !== 'undefined') {
                    list_refs.push(seq);
                }
            }

            for (i = 0; i < json_list.length; i++) {
                var theta = i * 2 * Math.PI / json_list.length;
                s.graph.addNode({
                    id: '' + json_list[i].query.substring(3, 11),
                    label: '' + json_list[i].query.substring(3, 11),
                    x: 10 * Math.sin(theta),
                    y: 10 * Math.cos(theta),
                    size: 1
                });
            }

            for (i = 0; i < json_list.length; i++) {
                for (j = 0; j < list_refs[i].length; j++) {
                    for (k = 0; k < json_list.length; k++) {
                        if (list_refs[i][j] === json_list[k].query.substring(3, 11)) {
                            s.graph.addEdge({
                                id: 'e' + '(' + i + ',' + k + ')',
                                source: '' + json_list[i].query.substring(3, 11),
                                target: '' + json_list[k].query.substring(3, 11),
                                size: 1
                            });
                            list_edges = s.graph.edges();
                            for (q = 0; q < list_edges.length; q++) {
                                if (list_edges[q].source === json_list[k].query.substring(3, 11) && list_edges[q].target === json_list[i].query.substring(3, 11)) {
                                    s.graph.dropEdge('e' + '(' + k + ',' + i + ')');
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            s.refresh();
            showHelp();
            showInformation();

        }

        function numberOfRelatedSequences() {

            document.getElementById("sequence").addEventListener("click", clearInput);

            document.getElementById("buttonCompute").addEventListener("click", hideAccordion);
            document.getElementById("buttonDraw").addEventListener("click", hideAccordion);
            document.getElementById("buttonDraw2").addEventListener("click", hideAccordion);

            s.graph.edges().forEach(element => {
                element.color = "#000000";
            });

            s.graph.nodes().forEach(element => {
                element.color = "#007fff";
            });

            s.refresh();

            sequenceToEvaluate = document.getElementById("sequence").value;

            if (sequenceToEvaluate === "") {
                alert("There is no sequence inserted");
                return;
            }

            var numberOfReferences = 0;

            if (s.graph.edges().length === 0) {
                alert("You have to draw the graph first!");
                return;
            }

            s.graph.edges().forEach(element => {
                if (element.source === sequenceToEvaluate || element.target === sequenceToEvaluate)
                    numberOfReferences = numberOfReferences + 1;
            });


            if (numberOfReferences === 0) {
                alert("The selected sequence is not present in the graph");
                return;
            }

            s.graph.nodes().forEach(element => {
                if (element.id === sequenceToEvaluate) {
                    element.color = "#ff0000";
                    element.size = 2;
                } else {
                    element.size = 1;
                    element.color = "#007fff";
                }
            });

            s.refresh();
            showHelp();
            showInformation();

            document.getElementById("result").value = numberOfReferences;

            s.graph.edges().forEach(element => {
                if (element.source !== sequenceToEvaluate && element.target !== sequenceToEvaluate) {
                    element.color = "#b3b3b3";
                }
            });

            s.refresh();

        }

        function clearInput() {
            document.getElementById("sequence").value = "";
            document.getElementById("result").value = "";
            document.getElementById("startingSequence").value = "";
            document.getElementById("numberOfNodes").value = "";
            document.getElementById("download").value = "";
        }

        function hideAccordion() {
            document.getElementById("accordion2").style.display = "none";
        }

    </script>

</body>

</html>