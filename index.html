<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>
        Graph Visualization
    </title>

    <link rel="icon" type="image/ico" href="iconGraph.png" />

    <link rel="stylesheet" href="jquery-ui.css">

    <style type="text/css">
        body {
            margin: 10;
            background-color: #D3D3D3;
        }

        #accordion {
            width: 25%;
        }

        #accordion2 {
            width: 25%;
        }

        #graphSection {
            width: 50%;
            height: 80%;
        }

        #input {
            width: 10%;
            word-spacing: 5px;
        }

        #buttonDraw {
            width: 90px;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        #buttonDraw2 {
            width: 90px;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        #buttonCompute {
            width: 100px;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        #buttonAddNode {
            width: 110px;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        #buttonRemoveNode {
            width: 150px;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        #startingSequence {
            width: 70px;
        }

        #sequence {
            width: 70px;
        }

        #numberOfNodes {
            width: 70px;
        }

        #section1 {
            background-color: #ebebe0;
            text-align: justify;
            font-family: "Comic Sans MS";
        }

        #section2 {
            background-color: #ebebe0;
            font-family: "Comic Sans MS";
        }

        #section3 {
            background-color: #ebebe0;
            font-family: "Comic Sans MS";
            text-align: justify;
        }

        #section4 {
            background-color: #ebebe0;
            font-family: "Comic Sans MS";
        }

        #result {
            width: 70px;
        }

        #sequenceName {
            font-family: "Comic Sans MS";
        }

        #sequenceNumber {
            font-family: "Comic Sans MS";
        }

        #nodesClick {
            font-family: "Comic Sans MS";
            color: #3d3d29;
            text-shadow: 7px 7px 7px rgb(122, 122, 82);
            font-size: 20;
        }

        #download2 {
            width: auto;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        #download {
            width: 70px;
        }
    </style>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>
        $(function () {
            $("#accordion").accordion({
                collapsible: true,
                heightStyle: "content",
                active: false
            });
        });
    </script>

</head>

<body>
    <center>
        <font size="10" color="Black" style="text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;">
            Interactive Graph
        </font>
        <br>
        <br>
    </center>
    <div id="accordion" style="float: left;">
        <h3>
            <b>
                Starting sequence references
            </b>
        </h3>
        <div id="section1">
            <form action="javascript:drawSpecializedGraph()">
                <table>
                    Insert the id of the sequence of which you want to see all her references and the maximum number of
                    related sequences that you want to show, to draw the graph with these sequences related to the
                    starting sequence.
                    <br>
                    <br>
                    <tr>
                        <td>
                            <b>starting sequence</b>
                        </td>
                        <td>
                            <input type="text" id="startingSequence"
                                title="Insert the id of the sequence of which you want to see all the references">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <b>number of nodes</b>
                        </td>
                        <td>
                            <input type="text" id="numberOfNodes"
                                title="Insert the maximum number of related sequences that you want to show">
                        </td>
                    </tr>
                </table>
                <br>
                <input type="submit" value="Draw It!" id="buttonDraw"
                    title="Click here to draw the graph with all the related sequences from starting sequence">
            </form>
            <form action="javascript: addNodeToSpecializedGraph()">
                <select required oninvalid="this.setCustomValidity('Please select an item of the list')"
                    oninput="this.setCustomValidity('')" id="selectSequences">
                    <option>Choose</option>
                </select>
                <input type="submit" value="Add node" id="buttonAddNode">
            </form>
            <form action="javascript: removeNodeToSpecializedGraph()">
                <select required oninvalid="this.setCustomValidity('Please select an item of the list')"
                    oninput="this.setCustomValidity('')" id="selectSequences2">
                    <option>Choose</option>
                </select>
                <input type="submit" value="Remove node" id="buttonRemoveNode">
            </form>
        </div>
        <h3>
            <b>
                Fetched sequences
            </b>
        </h3>
        <div id="section2">
            <form action="javascript:drawFetchedSequencesGraph()" id="form2">
                Draw the graph with the fetched sequences.
                <br>
                <br>
                <input type="submit" value="Draw It!" id="buttonDraw2"
                    title="Click here to draw the graph with all the fetched related sequences">
            </form>
        </div>
        <h3>
            <b>
                Number of related sequences
            </b>
        </h3>
        <div id="section3">
            <form action="javascript:numberOfRelatedSequences()">
                Calculates how many related sequences there are compared to the one given among those fetched and shows
                only the nodes and the edges directly connected to the input sequence.
                <br>
                <br>
                <input type="text" id="sequence" title="Insert the sequence id">
                <input type="submit" value="Compute" id="buttonCompute" title="Click here to compute">
                <input type="text" id="result">
            </form>
        </div>
        <h3>
            <b>
                Download Sequences
            </b>
        </h3>
        <div id="section4">
            <form action="javascript: downloadSequence()">
                <table>
                    <tr>
                        <td>
                            <input type="text" name='sequence' id="download">
                        </td>
                        <td>
                            <input type="submit" value="Download It!" method="POST" id="download2">
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
    <div id="accordion2" style="float: right;">
        <h3>
            <b id="Title1">
            </b>
        </h3>
        <div id="sequenceName"></div>

        <h3>
            <b id="Title2">

            </b>
        </h3>
        <div id="sequenceNumber"></div>
    </div>

    <div id="graphSection" style="float: left;">
    </div>

    <p hidden id="nodesClick">Click on a node to show the associated informations</p>

    <script src="libraries\build\sigma.min.js"></script>

    <script src="libraries/sigma/plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js"></script>

    <script>

        var array_numbers = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
        document.getElementById("download").addEventListener("click", clearInput);
        var json_list = [];
        var json_list_support = [];

        $.ajax({
            type: "POST",
            cache: false,
            url: "https://localhost/tesi-magistrale/getFetchedInfo.php",
            async: false,
            success: function (list) {
                end = 9;
                for (p = 2; p < list.length; p = p + 15) {
                    json_list_support.push(list.substring(p, end));
                    end = end + 15;
                }
            },
            error: function () {
                alert("Error in json files reading");
            }
        });

        json_list_support.forEach(element => {
            $.ajax({
                type: "POST",
                cache: false,
                url: "https://localhost/materiale_Nocentini/oeis-tools-master/src/fetched/" + element + ".json",
                async: false,
                success: function (fileJSON) {
                    json_list.push(fileJSON);
                },
                error: function () {
                    alert("Error in json_list construction");
                }
            });
        });


        var s = new sigma({
            renderer: {
                container: document.getElementById('graphSection'),
                type: 'canvas'
            }
        });

        hideHelp();
        showInformation();

        s.settings({
            hoverFont: "Comic Sans MS",
            labelHoverBGColor: "default",
            defaultHoverLabelBGColor: "#ffffff",
            defaultNodeColor: "#007fff",
            nodeColor: "default",
            defaultEdgeColor: "#000000",
            edgeColor: "default",
            defaultLabelColor: "#F70611",
            labelColor: "default",
            labelHoverShadow: "default",
            labelHoverShadowColor: "#000099",
            labelThreshold: 100,
            enableCamera: false,
            enableEdgeHovering: true,
            maxNodeSize: 6
            //edgeHoverColor: 'default',
            //defaultEdgeHoverColor: '#000080',
            //edgeHoverSizeRatio: 4,
            //edgeHoverExtremities: true,
        });

        function take_sequences(sequenzaJSON) {
            xref_list = sequenzaJSON.results[0].xref;
            if (typeof xref_list !== 'undefined') {
                let array_sequences = [];
                for (i = 0; i < xref_list.length; i++) { // Loop that scans xref elements.
                    element = xref_list[i];
                    for (j = 0; j < element.length; j++) { // Loop that scans the letters of xref elements.
                        if (element[j] === "A") { // Each sequences has the form Axxxxxx.
                            for (v = 0; v < array_numbers.length; v++) {
                                if (element[j + 1] === array_numbers[v] && element.substring(j, j + 7) !== sequenzaJSON.query.substring(3, 11)) {
                                    array_sequences.push("A" + element.substring(j + 1, j + 7));
                                    j = j + 7; // Useful for optimizing the code. If you find a "A", you can jump the next xxxxxx.
                                    break;
                                }
                            }
                        }
                    }
                }
                var set_sequences = [...new Set(array_sequences)];             
                return set_sequences;
            } else {
                return 'undefined';
            }
        }

        function drawSpecializedGraph() {

            s.graph.clear();

            var present = false;

            document.getElementById("startingSequence").addEventListener("click", clearInput);
            document.getElementById("buttonDraw").addEventListener("click", hideAccordion);
            document.getElementById("buttonDraw2").addEventListener("click", hideAccordion);
            document.getElementById("buttonCompute").addEventListener("click", hideAccordion);

            sequence = document.getElementById("startingSequence").value;
            nodesToAdd = document.getElementById("numberOfNodes").value;

            if (sequence === "" && nodesToAdd === "") {
                alert("Both the starting sequence and the number of nodes not inserted");
                return;
            } else if (sequence === "") {
                alert("There is no sequence inserted");
                return;
            } else if (nodesToAdd === "") {
                alert("Number of nodes not inserted");
                return;
            }

            json_list.forEach(element => {
                if (element.query.substring(3, 11) === sequence) {
                    s.graph.addNode({
                        id: '' + sequence,
                        label: '' + sequence,
                        x: 1,
                        y: 1,
                        size: 5
                    });
                    initial_sequence = element;
                    present = true;
                    return;
                }
            });

            if (typeof initial_sequence === 'undefined' || present === false) {
                alert("The sequence " + sequence + " has not been fetched!");
                return;
            }

            let nodes_list = take_sequences(initial_sequence);

            if (nodesToAdd > nodes_list.length) {
                alert("The maximum number of nodes that can be requested is " + nodes_list.length);
            } else {
                for (i = 0; i < nodesToAdd; i++) {
                    var theta = i * 2 * Math.PI / nodesToAdd;
                    s.graph.addNode({
                        id: '' + nodes_list[i],
                        label: '' + nodes_list[i],
                        x: 10 * Math.sin(theta),
                        y: 10 * Math.cos(theta),
                        size: 3
                    }).addEdge({
                        id: 'e' + s.graph.edges().length,
                        source: '' + sequence,
                        target: '' + nodes_list[i],
                        size: 3
                    });
                }
                s.refresh();
                document.getElementById("nodesClick").style.display = "block";
                optionsInitializationAddNodes();
                optionsInitializationRemoveNodes();
            }
        }

        function showInformation() { // This function shows informations about the selected sequence.

            s.bind("clickNode", function (e) {

                $("#accordion2").accordion({ // This is the accordion where informations'll shown.
                    collapsible: true,
                    heightStyle: "content",
                    active: 0
                });

                document.getElementById("accordion2").style.display = "block";
                document.getElementById("Title1").innerHTML = "Sequence Name and Recurrence Function";
                document.getElementById("Title2").innerHTML = "Sequence Number";

                entered = false;

                json_list.forEach(element => {
                    if (e.data.node.label === element.query.substring(3, 11)) {
                        document.getElementById("sequenceName").innerHTML = element.query.substring(3, 11) + "<br>" + element.results[0].name;
                        document.getElementById("sequenceNumber").innerHTML = element.results[0].data;
                        entered = true;
                        return;
                    }
                });

                if (!entered) {
                    alert("The clicked sequence " + e.data.node.label + " has not been fetched");
                    document.getElementById("accordion2").style.display = "none";
                    document.getElementById("nodesClick").style.display = "block";
                }

            });

        }

        function hideHelp() {
            s.bind("clickNode", function () {
                document.getElementById("nodesClick").style.display = "none";
            });
        }

        function getRandomArbitrary(min, max) {
            return Math.random() * (max - min) + min;
        }

        function drawFetchedSequencesGraph() {

            s.graph.clear();

            document.getElementById("buttonDraw").addEventListener("click", hideAccordion);
            document.getElementById("buttonDraw2").addEventListener("click", hideAccordion);
            document.getElementById("buttonCompute").addEventListener("click", hideAccordion);

            var list_refs = [];

            for (z = 0; z < json_list.length; z++) {
                seq = take_sequences(json_list[z]);
                if (typeof seq !== 'undefined') {
                    list_refs.push(seq);
                }
            }

            var setPositions = new Set();

            while (setPositions.size < json_list.length * 2) {
                xPosition = Math.round(getRandomArbitrary(0, 10000));
                yPosition = Math.round(getRandomArbitrary(0, 10000));
                setPositions.add(xPosition);
                setPositions.add(yPosition);
            }

            var arrayPositions = Array.from(setPositions);

            for (i = 0; i < json_list.length; i++) {
                s.graph.addNode({
                    id: '' + json_list[i].query.substring(3, 11),
                    label: '' + json_list[i].query.substring(3, 11),
                    x: arrayPositions[i],
                    y: arrayPositions[i + 1],
                    size: 1
                });
            }

            for (i = 0; i < json_list.length; i++) {
                for (j = 0; j < list_refs[i].length; j++) {
                    for (k = 0; k < json_list.length; k++) {
                        if (list_refs[i][j] === json_list[k].query.substring(3, 11) && (i !== k)) {
                            s.graph.addEdge({
                                id: 'e' + '(' + i + ',' + k + ')',
                                source: '' + json_list[i].query.substring(3, 11),
                                target: '' + json_list[k].query.substring(3, 11),
                                size: 1
                            });
                            /*list_edges = s.graph.edges();
                            for (q = 0; q < list_edges.length; q++) {
                                if (list_edges[q].source === json_list[k].query.substring(3, 11) && list_edges[q].target === json_list[i].query.substring(3, 11)) {
                                    s.graph.dropEdge('e' + '(' + k + ',' + i + ')');
                                    break;
                                }
                            }*/
                        }
                    }
                }
            }

            list_edges = s.graph.edges();

            for (q = 0; q < list_edges.length; q++) {
                for (p = q + 1; p < list_edges.length; p++) {
                    if ((list_edges[q].source === list_edges[p].target) && (list_edges[q].target === list_edges[p].source)) {
                        s.graph.dropEdge(list_edges[p].id);
                    }
                }
            }

            s.refresh();
            document.getElementById("nodesClick").style.display = "block";

        }

        function numberOfRelatedSequences() {

            document.getElementById("sequence").addEventListener("click", clearInput);
            document.getElementById("buttonCompute").addEventListener("click", hideAccordion);
            document.getElementById("buttonDraw").addEventListener("click", hideAccordion);
            document.getElementById("buttonDraw2").addEventListener("click", hideAccordion);

            s.graph.edges().forEach(element => {
                element.color = "#000000";
            });

            s.graph.nodes().forEach(element => {
                element.color = "#007fff";
            });

            s.refresh();

            sequenceToEvaluate = document.getElementById("sequence").value;

            if (sequenceToEvaluate === "") {
                alert("There is no sequence inserted");
                return;
            }

            var numberOfReferences = 0;

            if (s.graph.edges().length === 0) {
                alert("You have to draw the graph first!");
                return;
            }

            s.graph.edges().forEach(element => {
                if (element.source === sequenceToEvaluate || element.target === sequenceToEvaluate)
                    numberOfReferences = numberOfReferences + 1;
            });


            if (numberOfReferences === 0) {
                var here = false;
                s.graph.nodes().forEach(element => {
                    if (element.id === sequenceToEvaluate) {
                        element.color = "#ff0000";
                        here = true;
                        return;
                    }
                });
                if (here) {
                    alert("The selected sequence is present in the graph but it hasn't references");
                } else {
                    alert("The selected sequence is not present in the graph");
                }
                return;
            }

            s.graph.nodes().forEach(element => {
                if (element.id === sequenceToEvaluate) {
                    element.color = "#ff0000";
                    element.size = 2;
                } else {
                    element.size = 1;
                    element.color = "#007fff";
                }
            });

            s.refresh();
            document.getElementById("result").value = numberOfReferences;

            s.graph.edges().forEach(element => { //First of all, we have to draw the edges to hide.
                if (element.source !== sequenceToEvaluate && element.target !== sequenceToEvaluate) {
                    element.color = "#b3b3b3";
                } else {
                    s.graph.dropEdge(element.id);
                    s.graph.addEdge(element);
                }
            });

            /* And then, we have to draw the edges to show and highlight.
            * step 1: draw all edges to highlight and save them.
            * step 2: redraw the edges to highlight, and now we don't have problems with the overlap.
            */

            s.refresh();

            document.getElementById("nodesClick").style.display = "block";
        }

        function clearInput() {
            document.getElementById("sequence").value = "";
            document.getElementById("result").value = "";
            document.getElementById("startingSequence").value = "";
            document.getElementById("numberOfNodes").value = "";
            document.getElementById("download").value = "";
        }

        function hideAccordion() {
            document.getElementById("accordion2").style.display = "none";
        }

        sigma.plugins.dragNodes(s, s.renderers[0]); // This statement allows to do drag and drops with nodes of every drawed graph.

        function optionsInitializationAddNodes() {

            current_sequence = document.getElementById("startingSequence").value; // current_sequence = sequence written in the input text.
            nodesToAdd_current = document.getElementById("numberOfNodes").value;

            var nodes_list2 = [];

            json_list.forEach(element => {
                if (element.query.substring(3, 11) === current_sequence) {
                    nodes_list2 = take_sequences(element);
                    return;
                }
            });

            var options = [];

            for (f = nodesToAdd_current; f < nodes_list2.length; f++) {
                options.push(nodes_list2[f]);
            }

            $("#selectSequences").empty().append('<option value="">Choose</option>');

            var select = document.getElementById("selectSequences");

            for (d = 0; d < options.length; d++) {
                var option = options[d];
                var optionHTML = document.createElement("option");
                optionHTML.textContent = option;
                optionHTML.value = option;
                select.appendChild(optionHTML);
            }

        }

        function addNodeToSpecializedGraph() {

            if (s.graph.edges().length === 0) {
                alert("You have to draw the graph first!");
                return;
            }

            var sequenceToDraw = document.getElementById("selectSequences").value;

            s.graph.addNode({
                id: '' + sequenceToDraw,
                label: '' + sequenceToDraw,
                size: 3
            }).addEdge({
                id: 'e' + document.getElementById("startingSequence").value + sequenceToDraw,
                source: '' + document.getElementById("startingSequence").value,
                target: '' + sequenceToDraw,
                size: 3
            });

            s.graph.nodes().forEach(function (element, k) {
                if (k === 0) {
                    s.graph.nodes()[0].x = 1;
                    s.graph.nodes()[0].y = 1;
                } else {
                    var theta = k * 2 * Math.PI / (s.graph.nodes().length - 1);
                    element.x = 10 * Math.sin(theta);
                    element.y = 10 * Math.cos(theta);
                }
            });

            s.refresh();

            var select = document.getElementById("selectSequences");
            var select2 = document.getElementById("selectSequences2");

            for (i = 0; i < select.options.length; i++) { // Removal of the added sequence.
                if (select.options[i].value === sequenceToDraw) {
                    var option = select.options[i].value;
                    select.options[i] = null; // Update of the add men첫.
                    var optionHTML = document.createElement("option");
                    optionHTML.textContent = option;
                    optionHTML.value = option;
                    select2.appendChild(optionHTML); //Update of remove men첫
                    break;
                }
            }

        }

        function optionsInitializationRemoveNodes() {

            current_sequence = document.getElementById("startingSequence").value;
            showedNodes_current = document.getElementById("numberOfNodes").value;

            var nodes_list3 = [];

            json_list.forEach(element => {
                if (element.query.substring(3, 11) === current_sequence) {
                    nodes_list3 = take_sequences(element);
                    return;
                }
            });

            var options2 = [];

            for (g = 0; g < showedNodes_current; g++) {
                options2.push(nodes_list3[g]);
            }

            $("#selectSequences2").empty().append('<option value="">Choose</option>');

            var select = document.getElementById("selectSequences2");

            for (p = 0; p < options2.length; p++) {
                var option = options2[p];
                var optionHTML = document.createElement("option");
                optionHTML.textContent = option;
                optionHTML.value = option;
                select.appendChild(optionHTML);
            }

        }

        function removeNodeToSpecializedGraph() {

            if (s.graph.edges().length === 0) {
                alert("You have to draw the graph first!");
                return;
            }

            var sequenceToRemove = document.getElementById("selectSequences2").value;
            var current_sequence = document.getElementById("startingSequence").value;

            s.graph.dropNode(sequenceToRemove);

            s.graph.nodes().forEach(function (element, k) {
                if (k === 0) {
                    s.graph.nodes()[0].x = 1;
                    s.graph.nodes()[0].y = 1;
                } else {
                    var theta = k * 2 * Math.PI / (s.graph.nodes().length - 1);
                    element.x = 10 * Math.sin(theta);
                    element.y = 10 * Math.cos(theta);
                }
            });

            s.refresh();

            var select = document.getElementById("selectSequences");
            var select2 = document.getElementById("selectSequences2");

            for (i = 0; i < select2.options.length; i++) { // Removal of the selected sequence.
                if (select2.options[i].value === sequenceToRemove) {
                    var option2 = select2.options[i].value;
                    select2.options[i] = null; // Update of the remove men첫.
                    var optionHTML2 = document.createElement("option");
                    optionHTML2.textContent = option2;
                    optionHTML2.value = option2;
                    select.appendChild(optionHTML2); //Update of the add men첫
                    break;
                }
            }
        }

        function downloadSequence() {
            var sequenceToFetch = document.getElementById("download").value;
            $.ajax({
                type: "GET",
                cache: false,
                url: "https://localhost/tesi-magistrale/fetch.php",
                async: false,
                data: { download: sequenceToFetch },
                success: function (JSONfile) {
                    alert("Sequence " + sequenceToFetch + " has been correctly fetched!");
                    $.ajax({
                        type: "POST",
                        cache: false,
                        url: "https://localhost/materiale_Nocentini/oeis-tools-master/src/fetched/" + sequenceToFetch + ".json",
                        async: false,
                        success: function (fileJSON) {
                            json_list.push(fileJSON);
                        },
                        error: function () {
                            alert("Error in json_list construction");
                        }
                    });
                },
                error: function () {
                    alert("Error in the fetch of the sequence!");
                }
            });
        }

    </script>

</body>

</html>