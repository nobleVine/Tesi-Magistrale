<html>

<head>

    <title>
        Database
    </title>

    <link rel="icon" type="image/ico" href="..\img\iconDB.png" />

    <style>
        input.text {
            width: 100px;
            height: auto;
        }

        input.button {
            width: 130px;
            height: 35px;
            background-color: #d6d6c2;
            border-radius: 6px;
            font-style: italic;
            font-size: 20;
        }

        body {
            background-color: #D3D3D3;
        }

        legend {
            display: inline-block;
            width: auto;
        }

        fieldset {
            display: inline-block;
            border: 2px black solid;
            width: auto;
            height: auto;
            position: relative;
            bottom: 42px;
            left: 10px;
            margin-left: 0.5x;
            margin-right: 0.5px;
        }

        #queryResults {
            height: auto;
        }

        #textInputQuery {
            height: 100px;
            width: 150px;
        }
    </style>

</head>

<body>

    <table cellspacing=4>
        <tr>
            <td>
                <h3>
                    Select from those in the drop-down menù 
                    <br>
                    which information of the fetched sequences shows
                </h3>
            </td>
            <br>
            <td>
                <form action="javascript: query1()">
                    <select required oninvalid="this.setCustomValidity('Please select an item of the list')"
                        oninput="this.setCustomValidity('')" id="selectInfo">
                        <option value="">Choose</option>
                        <option>greeting</option>
                        <option>count</option>
                        <option>start</option>
                        <option>number</option>
                        <option>id</option>
                        <option>data</option>
                        <option>name</option>
                        <option>comment</option>
                        <option>reference</option>
                        <option>link</option>
                        <option>formula</option>
                        <option>example</option>
                        <option>maple</option>
                        <option>mathematica</option>
                        <option>program</option>
                        <option>xref</option>
                        <option>keyword</option>
                        <option>offset</option>
                        <option>author</option>
                        <option>references</option>
                        <option>revision</option>
                        <option>time</option>
                        <option>created</option>
                    </select>
            </td>
            <td>
                <input class="button" type="submit" value="Query 1">
            </td>
            </form>
            <td rowspan="3">
                <fieldset>
                    <legend>
                        <h3><b>Legend</b></h3>
                    </legend>
                    Possible informations to show: <br>
                    <ul>
                        <li><b>Greeting:</b> website where a sequence is located </li>
                        <li><b>Number:</b> number of a sequence </li>
                        <li><b>Id:</b> id of a sequence </li>
                        <li><b>Data:</b> the numbers which belong to a sequence</li>
                        <li><b>Name:</b> name of a sequence</li>
                        <li><b>Comment:</b> informations about a sequence and her relationships with <br> other
                            sequences</li>
                        <li><b>Reference:</b> references to books, journal papers, and other material not found online
                        </li>
                        <li><b>Link:</b> links to journal papers, preprints, illustrations, web pages, and other
                            material</li>
                        <li><b>Formula:</b> formulas, recurrences, generating functions for a sequence</li>
                        <li><b>Example:</b> examples of how to find or interpret terms of a sequence</li>
                        <li><b>Maple:</b> a Maple program </li>
                        <li><b>Mathematica:</b> a Wolfram Mathematica program </li>
                        <li><b>Program:</b> a program in some language other than Maple or Mathematica </li>
                        <li><b>XRef:</b> which sequences are related to a sequence </li>
                        <li><b>Keyword:</b> the OEIS has its own standard set of keywords <br> that characterize each
                            sequence</li>
                        <li><b>Offset:</b> index of the first term of a sequence </li>
                        <li><b>Author:</b> the person who submitted the sequence,<br> not the author of the sequence
                        </li>
                        <li><b>References:</b> number of references of a sequence </li>
                        <li><b>Revision:</b> number of a revisions of the page of a sequence in the website </li>
                        <li><b>Time:</b> time in which has been done the last revision of the page </li>
                        <li><b>Created:</b> date of the creation of the page</li>
                    </ul>
                </fieldset>
            </td>
        </tr>
        <tr>
            <td>
                <h3>
                    Select the information from those in the
                    <br>
                    drop-down menù of the fetched sequences in  
                    <br>
                    which search the string inserted in the text box
                </h3>
            </td>
            <td>
                <form action="javascript: query2()">
                    <select required oninvalid="this.setCustomValidity('Please select an item of the list')"
                        oninput="this.setCustomValidity('')" id="selectInfo2">
                        <option value="">Choose</option>
                        <option>greeting</option>
                        <option>count</option>
                        <option>start</option>
                        <option>number</option>
                        <option>id</option>
                        <option>data</option>
                        <option>name</option>
                        <option>comment</option>
                        <option>reference</option>
                        <option>link</option>
                        <option>formula</option>
                        <option>example</option>
                        <option>maple</option>
                        <option>mathematica</option>
                        <option>program</option>
                        <option>xref</option>
                        <option>keyword</option>
                        <option>offset</option>
                        <option>author</option>
                        <option>references</option>
                        <option>revision</option>
                        <option>time</option>
                        <option>created</option>
                    </select>
                    <br>
                    <br>
                    <input class="text" type="text" id="input1">
            </td>
            <td>
                <input class="button" type="submit" value="Query 2">
            </td>
            </form>
        </tr>
        <tr>
            <form action="javascript: freeQuery()">
                <td>
                    <h3>
                        Write a query in the text area
                    </h3>
                </td>
                <td>
                    <textarea id="textInputQuery"></textarea>
                </td>
                <td>
                    <input class="button" type="submit" value="Query">
                </td>
            </form>
        </tr>
    </table>

    <h3 hidden id="QR">
        <b>
            Query Results:
        </b>
    </h3>

    <table id="tableResults">
        <!-- Query results -->
    </table>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>

        $.ajax({ // This ajax request is useful to update the database with the last fatched sequences.
            type: "GET",
            url: "https://localhost/tesi-magistrale/php/populateDB.php",
            async: false,
            success: function () {
                alert("database successfully updated!");
            },
            error: function () {
                alert("Error in the ajax request!");
            }
        });

        document.getElementById("input1").addEventListener("click", clearInput);

        function query1() {

            document.getElementById("QR").style.display = "block";

            $.ajax({
                type: "POST",
                url: "https://localhost/tesi-magistrale/php/genericQuery.php",
                async: false,
                data: {
                    string: document.getElementById("selectInfo").value
                },
                success: function (queryResults) {

                    var tableResults = document.getElementById("tableResults");
                    tableResults.setAttribute("border", 1);

                    if (tableResults === null) {
                        var tableResults = document.createElement("table");
                        tableResults.setAttribute("id", "tableResults");
                        tableResults.setAttribute("border", 1);
                    }

                    while (tableResults.hasChildNodes()) {
                        tableResults.removeChild(tableResults.firstChild);
                    }

                    var input = document.getElementById("selectInfo").value;

                    if (input === "greeting" || input === "count" || input === "start" || input === "number" || input === "id"
                        || input === "data" || input === "name" || input === "comment" || input === "reference" || input === "link"
                        || input === "formula" || input === "example" || input === "maple" || input === "mathematica" || input === "program"
                        || input === "xref" || input === "keyword" || input === "offset" || input === "author" || input === "references"
                        || input === "revision" || input === "time" || input === "created") {

                        var array_results = splitString(queryResults);
                    }

                    for (i = 0; i < array_results.length; i = i + 2) {
                        var tr = document.createElement("tr");
                        for (j = i; j < i + 2; j++) {
                            var td = document.createElement("td");
                            td.appendChild(document.createTextNode(array_results[j]));
                            tr.appendChild(td);
                        }
                        tableResults.appendChild(tr);

                    }
                },
                error: function () {
                    alert("Query error!");
                }
            });

            reinitializationDropDownMenu("selectInfo");
        }

        function query2() {

            if (document.getElementById("input1").value === "") {
                alert('String to search not inserted');
                return;
            }

            document.getElementById("QR").style.display = "block";

            $.ajax({
                type: "POST",
                url: "https://localhost/tesi-magistrale/php/querySearchStringInColumn.php",
                async: false,
                data: {
                    string1: document.getElementById("selectInfo2").value,
                    string2: document.getElementById("input1").value
                },
                success: function (queryResults) {

                    document.getElementById("tableResults").innerHTML = "";

                    if(checkEmptyResult(queryResults) === -1) {
                        document.getElementById("tableResults").setAttribute("border", 0);
                        return;
                    }

                    document.getElementById("tableResults").setAttribute("border", 1);

                    queryResults = queryResults.slice(1, queryResults.length - 1);
                    var array_results = queryResults.split(",");

                    for (i = 0; i < array_results.length; i++) {
                        var tr = document.createElement("tr");
                        var td = document.createElement("td");
                        td.appendChild(document.createTextNode(array_results[i].substring(4, 11)));
                        tr.appendChild(td);
                        tableResults.appendChild(tr);
                    };

                },
                error: function () {
                    alert("Query error!");
                }
            })
            reinitializationDropDownMenu("selectInfo2");
        }

        function splitString(queryResults) {

            var array_results = [];
            var finish = false;
            var y = 0;
            var i = 2;

            while (i < queryResults.length) {
                if (queryResults[i] === "i" && queryResults[i + 1] === "d" && queryResults[i + 2] === ":") {
                    finish = false;
                    y = i + 3;
                    while (!finish && y < queryResults.length) {
                        if (queryResults[y] === "i" && queryResults[y + 1] === "d" && queryResults[y + 2] === ":") {
                            array_results.push(queryResults.substring(i + 3, i + 10));
                            array_results.push(queryResults.substring(i + 13, y - 3));
                            finish = true;
                        } else {
                            y++;
                        }
                    }
                    i = y;
                }
                else {
                    i++;
                }
            }

            var k = y - 3;
            var last = false;

            while (!last) {
                if (queryResults[k] === "i" && queryResults[k + 1] === "d" && queryResults[k + 2] === ":") {
                    array_results.push(queryResults.substring(k + 3, k + 10));
                    array_results.push(queryResults.substring(k + 13, queryResults.length - 2));
                    last = true;
                } else {
                    k--;
                }
            }

            for (p = 0; p < array_results.length; p++) {
                if (array_results[p] === "ul") {
                    array_results[p] = "null";
                }
            }

            return array_results;

        }

        function reinitializationDropDownMenu(id) {
            $("#" + id).empty().append('<option value="">Choose</option>').append('<option>greeting</option>').
                append('<option>count</option>').append('<option>start</option>').append('<option>number</option>').
                append('<option>id</option>').append('<option>data</option>').append('<option>name</option>').
                append('<option>comment</option>').append('<option>reference</option>').append('<option>link</option>').
                append('<option>formula</option>').append('<option>example</option>').append('<option>maple</option>').
                append('<option>mathematica</option>').append('<option>program</option>').append('<option>xref</option>').
                append('<option>keyword</option>').append('<option>offset</option>').append('<option>author</option>').
                append('<option>references</option>').append('<option>revision</option>').append('<option>time</option>').
                append('<option>created</option>');
        }

        function clearInput() {
            document.getElementById("input1").value = "";
        }

        function freeQuery() {

            document.getElementById("QR").style.display = "block";

            $.ajax({
                type: "POST",
                url: "https://localhost/tesi-magistrale/php/freeQuery.php",
                async: false,
                data: {
                    string1: document.getElementById("textInputQuery").value,
                },
                success: function (queryResults) {

                    var column = takeColummn(queryResults);
                    document.getElementById("tableResults").innerHTML = "";

                    if(checkEmptyResult(queryResults) === -1) {
                        document.getElementById("tableResults").setAttribute("border", 0);
                        return;
                    }

                    document.getElementById("tableResults").setAttribute("border", 1);

                    queryResults = queryResults.slice(1, queryResults.length - 1);
                    var array_results = queryResults.split("{" + column + ":");

                    for (i = 1; i < array_results.length - 1; i++) {
                        var tr = document.createElement("tr");
                        var td = document.createElement("td");
                        td.appendChild(document.createTextNode("{" + column + ":" + array_results[i].substring(0, array_results[i].length - 1)));
                        tr.appendChild(td);
                        tableResults.appendChild(tr);
                    };

                    var tr = document.createElement("tr");
                    var td = document.createElement("td");
                    td.appendChild(document.createTextNode("{" + column + ":" + array_results[i]));
                    tr.appendChild(td);
                    tableResults.appendChild(tr);

                },
                error: function () {
                    alert("Query error!");
                }
            })
        }

        function takeColummn(queryResults) {
            var i = 0;
            while (true) {
                if (queryResults[i] === '"') {
                    var j = i + 1;
                    while (true) {
                        if (queryResults[j] === '"') {
                            return queryResults.substring(i, j + 1);
                        }
                        j++;
                    }
                } else {
                    i++;
                }
            }
        }

        function checkEmptyResult(qResult) {
            if (qResult === "[]") {
                alert("The query result is empty!");
                return -1;
            }
        }

    </script>

</body>

</html>